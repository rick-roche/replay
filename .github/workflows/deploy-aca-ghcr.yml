name: Deploy ACA from GHCR

on:
  workflow_dispatch:
    inputs:
      container_image:
        description: "Container image to deploy (override if your Aspire push uses a different image path)"
        required: false
        type: string
      run_push:
        description: "Run `aspire do push` before deploy"
        required: true
        default: true
        type: boolean
  push:
    branches: ["main"]

permissions:
  contents: read
  packages: write
  id-token: write

concurrency:
  group: deploy-aca-ghcr
  cancel-in-progress: false

env:
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: 1

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: global.json

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Install Aspire CLI
        run: |
          echo "Installing Aspire CLI from install script..."
          curl -sSL https://aspire.dev/install.sh | bash -s -- -q dev

      - name: Setup AZD
        uses: Azure/setup-azd@v2

      - name: Azure login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Login to GHCR for push
        if: ${{ github.event_name == 'push' || github.event.inputs.run_push == 'true' }}
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Push image(s) to GHCR with Aspire
        if: ${{ github.event_name == 'push' || github.event.inputs.run_push == 'true' }}
        env:
          PARAMETERS__REGISTRY_ENDPOINT: ghcr.io
          PARAMETERS__REGISTRY_REPOSITORY: ${{ vars.GHCR_REPOSITORY != '' && vars.GHCR_REPOSITORY || github.repository }}
        run: aspire do push --project src/RePlay.AppHost/RePlay.AppHost.csproj --non-interactive

      - name: Resolve deployment settings
        id: settings
        env:
          INPUT_IMAGE: ${{ github.event.inputs.container_image }}
          GHCR_REPOSITORY: ${{ vars.GHCR_REPOSITORY }}
          ACA_APP_NAME: ${{ vars.ACA_APP_NAME }}
          ACA_ENV_NAME: ${{ vars.ACA_ENV_NAME }}
          AZURE_RESOURCE_GROUP: ${{ vars.AZURE_RESOURCE_GROUP }}
          AZURE_LOCATION: ${{ vars.AZURE_LOCATION }}
          AZD_ENV_NAME: ${{ vars.AZD_ENV_NAME }}
        run: |
          set -euo pipefail

          app_name="${ACA_APP_NAME:-replay}"
          environment_name="${ACA_ENV_NAME:-replay-env}"
          resource_group="${AZURE_RESOURCE_GROUP:-replay-rg}"
          location="${AZURE_LOCATION:-uksouth}"
          azd_environment_name="${AZD_ENV_NAME:-prod}"

          ghcr_repo="${GHCR_REPOSITORY:-${GITHUB_REPOSITORY}}"
          image_default="ghcr.io/${ghcr_repo}/server:latest"
          image="${INPUT_IMAGE:-$image_default}"

          echo "app_name=$app_name" >> "$GITHUB_OUTPUT"
          echo "environment_name=$environment_name" >> "$GITHUB_OUTPUT"
          echo "resource_group=$resource_group" >> "$GITHUB_OUTPUT"
          echo "location=$location" >> "$GITHUB_OUTPUT"
          echo "azd_environment_name=$azd_environment_name" >> "$GITHUB_OUTPUT"
          echo "image=$image" >> "$GITHUB_OUTPUT"

      - name: AZD login (federated)
        env:
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        run: |
          set -euo pipefail
          azd auth login \
            --client-id "$AZURE_CLIENT_ID" \
            --tenant-id "$AZURE_TENANT_ID" \
            --federated-credential-provider github \
            --no-prompt

      - name: Ensure AZD environment + provision infra
        id: azd
        env:
          AZD_ENV_NAME: ${{ steps.settings.outputs.azd_environment_name }}
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          AZURE_RESOURCE_GROUP: ${{ steps.settings.outputs.resource_group }}
          AZURE_LOCATION: ${{ steps.settings.outputs.location }}
          CONTAINER_APPS_ENVIRONMENT_NAME: ${{ steps.settings.outputs.environment_name }}
        run: |
          set -euo pipefail

          azd env select "$AZD_ENV_NAME" --no-prompt || azd env new "$AZD_ENV_NAME" --no-prompt

          azd env set AZURE_SUBSCRIPTION_ID "$AZURE_SUBSCRIPTION_ID"
          azd env set AZURE_RESOURCE_GROUP "$AZURE_RESOURCE_GROUP"
          azd env set AZURE_LOCATION "$AZURE_LOCATION"
          azd env set CONTAINER_APPS_ENVIRONMENT_NAME "$CONTAINER_APPS_ENVIRONMENT_NAME"

          azd provision --no-prompt

          resource_group="$(azd env get-value AZURE_RESOURCE_GROUP)"
          provisioned_env_name="$(azd env get-value CONTAINER_APPS_ENVIRONMENT_NAME)"

          echo "resource_group=$resource_group" >> "$GITHUB_OUTPUT"
          echo "environment_name=$provisioned_env_name" >> "$GITHUB_OUTPUT"

      - name: Ensure ACA extension is installed
        run: az extension add --name containerapp --upgrade --allow-preview true

      - name: Create or update ACA app (GHCR override)
        env:
          APP_NAME: ${{ steps.settings.outputs.app_name }}
          ENV_NAME: ${{ steps.azd.outputs.environment_name }}
          RESOURCE_GROUP: ${{ steps.azd.outputs.resource_group }}
          CONTAINER_IMAGE: ${{ steps.settings.outputs.image }}
          GHCR_USERNAME: ${{ secrets.GHCR_USERNAME }}
          GHCR_PAT: ${{ secrets.GHCR_PAT }}
          SPOTIFY_CLIENT_ID: ${{ secrets.SPOTIFY_CLIENT_ID }}
          SPOTIFY_CLIENT_SECRET: ${{ secrets.SPOTIFY_CLIENT_SECRET }}
          SPOTIFY_REDIRECT_URI: ${{ secrets.SPOTIFY_REDIRECT_URI }}
          LASTFM_API_KEY: ${{ secrets.LASTFM_API_KEY }}
          DISCOGS_CONSUMER_KEY: ${{ secrets.DISCOGS_CONSUMER_KEY }}
          DISCOGS_CONSUMER_SECRET: ${{ secrets.DISCOGS_CONSUMER_SECRET }}
          SETLISTFM_API_KEY: ${{ secrets.SETLISTFM_API_KEY }}
        run: |
          set -euo pipefail

          if [[ -z "${GHCR_USERNAME}" || -z "${GHCR_PAT}" ]]; then
            echo "GHCR_USERNAME and GHCR_PAT must be set as repository secrets."
            exit 1
          fi

          if [[ -z "${SPOTIFY_CLIENT_ID}" || -z "${SPOTIFY_CLIENT_SECRET}" || -z "${SPOTIFY_REDIRECT_URI}" ]]; then
            echo "Spotify secrets are required: SPOTIFY_CLIENT_ID, SPOTIFY_CLIENT_SECRET, SPOTIFY_REDIRECT_URI"
            exit 1
          fi

          if [[ -z "${RESOURCE_GROUP}" || -z "${ENV_NAME}" ]]; then
            echo "AZD provision did not return required values (AZURE_RESOURCE_GROUP / CONTAINER_APPS_ENVIRONMENT_NAME)."
            exit 1
          fi

          secrets=(
            "spotify-client-id=${SPOTIFY_CLIENT_ID}"
            "spotify-client-secret=${SPOTIFY_CLIENT_SECRET}"
            "spotify-redirect-uri=${SPOTIFY_REDIRECT_URI}"
          )

          env_vars=(
            "Spotify__ClientId=secretref:spotify-client-id"
            "Spotify__ClientSecret=secretref:spotify-client-secret"
            "Spotify__RedirectUri=secretref:spotify-redirect-uri"
            "ASPNETCORE_ENVIRONMENT=Production"
          )

          if [[ -n "${LASTFM_API_KEY}" ]]; then
            secrets+=("lastfm-api-key=${LASTFM_API_KEY}")
            env_vars+=("Lastfm__ApiKey=secretref:lastfm-api-key")
          fi

          if [[ -n "${DISCOGS_CONSUMER_KEY}" ]]; then
            secrets+=("discogs-consumer-key=${DISCOGS_CONSUMER_KEY}")
            env_vars+=("Discogs__ConsumerKey=secretref:discogs-consumer-key")
          fi

          if [[ -n "${DISCOGS_CONSUMER_SECRET}" ]]; then
            secrets+=("discogs-consumer-secret=${DISCOGS_CONSUMER_SECRET}")
            env_vars+=("Discogs__ConsumerSecret=secretref:discogs-consumer-secret")
          fi

          if [[ -n "${SETLISTFM_API_KEY}" ]]; then
            secrets+=("setlistfm-api-key=${SETLISTFM_API_KEY}")
            env_vars+=("SetlistFm__ApiKey=secretref:setlistfm-api-key")
          fi

          if az containerapp show --name "$APP_NAME" --resource-group "$RESOURCE_GROUP" >/dev/null 2>&1; then
            az containerapp secret set \
              --name "$APP_NAME" \
              --resource-group "$RESOURCE_GROUP" \
              --secrets "${secrets[@]}"

            az containerapp registry set \
              --name "$APP_NAME" \
              --resource-group "$RESOURCE_GROUP" \
              --server ghcr.io \
              --username "$GHCR_USERNAME" \
              --password "$GHCR_PAT"

            az containerapp update \
              --name "$APP_NAME" \
              --resource-group "$RESOURCE_GROUP" \
              --image "$CONTAINER_IMAGE" \
              --set-env-vars "${env_vars[@]}" \
              --min-replicas 0 \
              --max-replicas 1
          else
            az containerapp create \
              --name "$APP_NAME" \
              --resource-group "$RESOURCE_GROUP" \
              --environment "$ENV_NAME" \
              --image "$CONTAINER_IMAGE" \
              --registry-server ghcr.io \
              --registry-username "$GHCR_USERNAME" \
              --registry-password "$GHCR_PAT" \
              --secrets "${secrets[@]}" \
              --env-vars "${env_vars[@]}" \
              --ingress external \
              --target-port 8080 \
              --min-replicas 0 \
              --max-replicas 1 \
              --cpu 0.5 \
              --memory 1Gi
          fi

      - name: Output app URL
        env:
          APP_NAME: ${{ steps.settings.outputs.app_name }}
          RESOURCE_GROUP: ${{ steps.azd.outputs.resource_group }}
        run: |
          fqdn=$(az containerapp show --name "$APP_NAME" --resource-group "$RESOURCE_GROUP" --query properties.configuration.ingress.fqdn -o tsv)
          echo "App URL: https://${fqdn}"
          echo ""
          echo "Remember to set SPOTIFY_REDIRECT_URI to: https://${fqdn}/api/auth/callback"
